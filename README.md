# VKinder - бот Вконтакте для поиска второй половинки.
Данный бот имитирует работу всем знакомого приложения Tinder на основании анкет пользователей VK.

При запуске бота пользователем, бот получает информацию о пользователе: Город, Статус, Семейное положение, Возраст и на основе этих данных подбирает анкеты пользователей VK. Пользователь может менять критерии поиска в соотвествующем меню.

При запуске поиска, бот предложит пользователю всех найденных пользователей по критерям (Город, Статус, Семейное положение, Возраст), на оценку. В случае если понравившийся человек так же отметит пользователя через бота как понравившийся, то случится Match и пользователи получат ссылки на анкеты друг друга.

Ограничений по критериям нет, кроме возраста, доступен поиск пользователей от 18 до 60 лет.

## Подготовка к запуску
Для корректной работы бота необходимо:
1. Создать БД и таблицы
2. Установить необходимые библиотеки из requirements.txt
3. Создать страницу в VK и группу, получить токен группы VK и access токент пользователя.

### Создание БД и таблиц
Бот использует CУБД PostgreSQL, установить можно по [ссылке](https://www.postgresql.org).
После установки или же если PostgreSQL уже установлен, необходимо создать базу данных и польхователя БД.
Сделать это можно с помощью скрипта который расположен в `/VKinder_database/vkinder_create_db.sql`, после создания БД запустите скрипт
`/VKinder_database/vkinder_create_table.sql` чтобы наполнить БД необходимыми таблицами.

### Установка библиотек
Выполните команду `pip install -r requirements.txt` в терминале.

### Получение токенов и регистрация в VK.
В случае если у вас уже есть страница VK - авторизуйтесь на сайте, если нет, то зарегистрируйтесь.

Получение токена группы(сообщества):
1. Создайте группу (сообщество)
2. В группе зайдите в Управление -> Работа с API. Создать ключ.
3. Включить возможность писать сообщения в группу. Управление -> Сообщения -> Сообщения сообщества: включить.
4. Настройки бота. Возможности бота: Включены 

Получение токена пользователя:
1. 11
2. 

## Быстрый старт
Чтобы запустить сервер бота необходимо создать Python file и поместить в него код:

        from VKinder.VKinder_main import VKinder_server
        
        if __name__ == '__main__':
        VK_Tinder = VKinder_server.VKinder()
        VK_Tinder.launch()
        
Так же можно воспользоваться файлом `quick_start.py`.

## Описание библиотеки VKinder

### Описание модуля VKinder_main
#### VKinder_server.py cодерджит в себе класс VKinder

**Методы инициализации и запуска**
`__init__`: Запрашивает на стороне сервера токены, а также инициализирует класс, описывая переменные токенов, соединенеие через VK API, и подключение к БД. 
`launch`: Запускает бота, слушает все новые сообщения что приходит в бота через LongPoll со стороны ВК. Обрабатывает сообщения от пользователя, запуская методы ведения диалога с пользователем.

**Клавиатуры**
`city_keyboard`: Отображает пользователю бота клавиатуру выбора города.
`sex_keyboard`: Отображает пользователю бота клавиатуру выбора гендера для поиска.
`year_keyboard`: Отображает пользователю бота клавиатуру выбора года рождения, для поиска анкет.
`status_keyboard`: Отображает пользователю бота клавиатуру выбора статуса отношений, для поиска анкет.
`menu_keyboard`: Отображает пользователю бота клавиатуру с меню(доступных функций для пользователя) бота.
`settings_keyboard`: Отображает пользователю бота клавиатуру выбора настройки параметров поиска анкет.
`like_keyboard`: Отображает пользователю бота клавиатуру для выбора "Нравится/Не нравится" при оценке подобранных анкет ботом.
`matches_keyboard`: Отображает пользователю бота клавиатуру возврата в меню, при нахождении в разделе Совпадений.

**Стандартые методы**
`write_msg`: Метод содержащий в себе метод vk api для отправки сообщений. Используется для уменьшения и читаемости кода.
`get_user_info`: Метод содержащий в себе метод vk api для запроса данных (будущих параметров поиска) о пользователе бота.
`check_close_account`: Вспомогательный метод, содержащий в себе метод vk api для отсеивания из подобранных анкет закрытого профиля.

**Методы ведения диалога с пользователем**
`start`: Метод используется при начале работы пользователя с ботом. Данный метод проверяет, есть ли информация о пользователе в БД, если нет, то используя метод `get_user_info` передает в базу информацию о пользователе. В случае отсутствия каких-либо параметров в анкете пользователя, устанавливает занчения по умолчанию.
`menu`: Метод отображает клавиатуру возможных действий в боте.
`settings`: Метод отображает клавиатуру выбора параметра для внесений изменений, а также проверяет, нет ли в настоящий момент параметров, значение которых None, в случае наличия таковых, устанавливает для них значение по последнему сообщению от пользователя.
`set_settings`: Метод отображает необходимую клавиатуру для выбора пользователем, в зависимости от его выбора при работе метода `settings`, а также устаналивает значение None для параметра. После выбора варианта с клавиатуры, пользователя вернет в метод `settings`.
`start_search`: Метод выполняет поиск анкет пользователей vk по заданным пользователем параметрам и сохраняет для дальнейшей оценки в cache. Далее для каждой анкеты выводится ФИО и до 3 наиболее популярных фотографии анкеты, пользователю предлагается выбрать "Нравится/Не нравится" и в зависимости от его ответа данные записываются в таблицы БД. В случае, если пользователю понравилась анкета, метод проверит, есть ли запись в БД о том, что "Владелец понравившейся анкеты ранее отмечал пользователя как понравившийся?", если да, то в БД будут внесены записи в таблицу match'ей.
`print_matches`: Метод делает запрос к БД и получает все match для пользователя.

#### VKinder_chat_cache.py
1. Содержит в себе cache подобранных анкет для каждого пользователя, который является словарем, ключи которго содержат в себе списки.
2. Словарь relation и sex, чтобы резолвить значение одноименных параметров поиска для пользователя.

### Описание модуля VKinder_database
#### database_main.py содержит в себе класс DB
и описание таблиц БД через классы для sqlalchemy.

Класс DB содержит слежующие методы:
`__init__`:
`get_data`: Базовый метод, получет всю информацию из укзаанной таблицы.
`update_settings`: Метод обновляет данные в таблице user_search_settings по переданному параметру, переданным значением, для переданного пользователя. 
`get_user_settings`: Метод получает параметры поиска из таблицы user_search_settings для переданного пользователя.
`get_like_user`: Вспомогательный метод для получения записи в таблице like_table, по пользователю и анкете vk используется в классе VKinder
`get_dislike_user`: Вспомогательный метод для получения записи в таблице dislike_table, по пользователю и анкете vk используется в классе VKinder
`get_matches`: Вспомогательный метод для получения записи в таблице match_table, по пользователю и анкете vk используется в классе VKinder
`check_matches`: Вспомогательный метод проверяет, есть ли взаимный лайк у пользователя и анкеты vk.
`like_move_to_match`: Перемещает записи из like_table в match_table, в случае если у пользователя и анкеты vk есть взаимный лайк, удаляя эти записи в like_table.
`write_to_db`: Записывает переданную в БД информацию. 

#### database_settings.py
Содержит в себе параметры для формирования DSN при подключении к БД. В случае, если вы не пользовались скриптом `/VKinder_database/vkinder_create_db.sql` для создания БД и указывали свои параметры для названия БД, пользователя и пароля, хостнейма и порта подключения, данные в этом файле необходимо отредактировать.
